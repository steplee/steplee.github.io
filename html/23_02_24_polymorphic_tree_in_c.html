<!DOCTYPE html>
<html>
  <head>
    <title>Polymorphic Tree In C</title>
<link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jura&family=Roboto:wght@400&display=swap" rel="stylesheet">

    <link href="../res/main.css" rel="stylesheet">
    <link href="../res/boostrap.darkly.css" rel="stylesheet">
    <link href="../res/pygments.css" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" type="text/javascript"></script>
    <script async="async" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" type="text/javascript"></script>
  </head>
  <body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Navbar</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarColor02">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link active" href="../index.html">Blog
            <span class="visually-hidden">(current)</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/steplee">GitHub</a>
        </li>

        <!-- This is not working -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" id="dropdownMenuButton1" data-toggle="dropdown1">Links</a>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton1" id="dropdown1">
            <a class="dropdown-item" href="https://www.shadertoy.com/user/stephenl7797">ShaderToy</a>
            <a class="dropdown-item" href="https://www.shadertoy.com/user/stephenl7797">ShaderToy</a>
          </div>
        </li>

      </ul>
    </div>
  </div>
</nav>
    
<div  id="mainImage"></div>

    <div class="container">
      <h1>
        <span>Polymorhpic Tree in C</span>
      </h1>
      <p>
        <span>I was reading some kernel code today to try and see how </span>
        <a href="https://github.com/iovisor/bcc">BCC</a>
        <span> works with USDTs/uprobes and the ftrace/perf kernel subsystems.
</span>
      </p>
      <p>
        <span>I came across an interesting idiom in C for having allowing a balanced binary tree implementation to be used with different types.
</span>
      </p>
      <p>
        <span class="backticked">uprobes.c</span>
        <span> contains the following line </span>
        <span class="backticked">struct uprobe *u = rb_entry(n, struct uprobe, rb_node);</span>
        <span>, which expands to </span>
        <span class="backticked">struct uprobe *u = container_of(n, struct uprobe, rb_node);</span>
        <span>
</span>
      </p>
      <p>
        <span>This </span>
        <span class="backticked">container_of</span>
        <span> macro is defined in </span>
        <span class="backticked">include/linux/kernel.h</span>
        <span>, and so is probably widely used. It's defined as
</span>
      </p>
      <div class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * container_of - cast a member of a structure out to the containing structure</span>
<span class="cm"> * @ptr:	the pointer to the member.</span>
<span class="cm"> * @type:	the type of the container struct this is embedded in.</span>
<span class="cm"> * @member:	the name of the member within the struct.</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>
<span class="cp">#define container_of(ptr, type, member) ({			\</span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="n">typeof</span><span class="p">(((</span><span class="n">type</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">member</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">__mptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">	</span>\
<span class="w">	</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">__mptr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offsetof</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">member</span><span class="p">));</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
</pre></div>
</div>
      <p>
        <span>This takes a minute to parse, but it is just finding the pointer of a struct from a certain member of the struct.
</span>
      </p>
      <p>
        <span>So for example the uprobe struct has a member </span>
        <span class="backticked">rb_node</span>
        <span>, and the above </span>
        <span class="backticked">rb_entry</span>
        <span> macro finds the pointer to the base struct </span>
        <span class="backticked">uprobe</span>
        <span> given a pointer to the inner </span>
        <span class="backticked">rb_node</span>
        <span>.
</span>
      </p>
      <p>
        <span>This is kind of the reverse to how you'd normally do it in an object-oriented container based way.
</span>
      </p>
      <p>
        <span>In languages with generics you'd have a parameterized class, where the tree nodes contain pointers to your custom type.
</span>
      </p>
      <p>
        <span>In this approach, your custom type has a pointer to the tree node.
</span>
      </p>
    </div>
  </body>
</html>
